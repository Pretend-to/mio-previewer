# é¢è¯•æŒ‡åŒ—ï¼šmio-previewer Technical Architecture & QA

è¿™ä»½æ–‡æ¡£æ—¨åœ¨å¸®åŠ©ä½ å‘é¢è¯•å®˜æ·±å…¥é˜è¿° `mio-previewer` çš„æŠ€æœ¯ä»·å€¼ã€‚ä¸ä»…ä»…æ˜¯â€œå†™äº†ä¸€ä¸ªæ¸²æŸ“å™¨â€ï¼Œè€Œæ˜¯â€œè§£å†³äº†ä¸€ä¸ªç‰¹å®šçš„å·¥ç¨‹éš¾é¢˜â€ã€‚

---

## ğŸš€ æ ¸å¿ƒå™äº‹ (The "Elevator Pitch")

**ä¸€å¥è¯ä»‹ç»**ï¼š
â€œè¿™æ˜¯ä¸€ä¸ªä¸“ä¸º **AI å¤§æ¨¡å‹æµå¼å¯¹è¯** åœºæ™¯æ‰“é€ çš„ Vue 3 Markdown æ¸²æŸ“å¼•æ“ã€‚â€

**æ ¸å¿ƒå†²çª (The Problem)**ï¼š
ä¼ ç»Ÿçš„ Markdown æ¸²æŸ“ï¼ˆå¦‚ `markdown-it` + `v-html`ï¼‰æ˜¯ä¸ºé™æ€æ–‡æ¡£è®¾è®¡çš„ã€‚åœ¨ AI é€å­—åå‡ºçš„æµå¼åœºæ™¯ä¸‹ï¼Œä½¿ç”¨ `v-html` ä¼šå¯¼è‡´æ•´ä¸ª DOM åŒºåŸŸæ¯ç§’å‡ åæ¬¡çš„å…¨é‡é”€æ¯ä¸é‡å»ºï¼ˆEverything is destroyed and recreatedï¼‰ã€‚è¿™ä¼šå¯¼è‡´ï¼š

1.  **æ€§èƒ½ç¾éš¾**ï¼šé¢‘ç¹çš„ Layout å’Œ Paintã€‚
2.  **çŠ¶æ€ä¸¢å¤±**ï¼šç”¨æˆ·æ­£åœ¨ä¸æŸä¸ªå›¾è¡¨äº¤äº’ï¼Œçªç„¶æ•°æ®ä¸€åˆ·æ–°ï¼Œå›¾è¡¨é‡ç½®äº†ã€‚
3.  **ä½“éªŒå‰²è£‚**ï¼šå›¾ç‰‡é—ªçƒã€é€‰ä¸­æ–‡å­—è¢«é‡ç½®ã€‚

**ä½ çš„è§£å†³æ–¹æ¡ˆ (The Solution)**ï¼š
æˆ‘è®¾è®¡äº†ä¸€å¥— **"Stream-to-VNode"** çš„ç®¡çº¿ã€‚é€šè¿‡å°† HTML è§£æä¸º ASTï¼Œå†æ˜ å°„ä¸º Vue çš„ VNode æ ‘ï¼Œæˆ‘æˆåŠŸå°† Markdown æ¸²æŸ“çº³å…¥äº† Vue çš„ **Reactivity & Diffing** ä½“ç³»ã€‚å“ªæ€•åº•å±‚åœ¨å…¨é‡è§£æï¼Œè¡¨ç°å±‚ï¼ˆDOMï¼‰åªä¼šåœ¨æœ«ç«¯å‘ç”Ÿæå…¶å¾®å°çš„å¢é‡æ›´æ–°ã€‚

---

## ğŸ’¡ æ·±åº¦ QA æŒ‡å—

### 1. æŠ€æœ¯æ·±åº¦ï¼šå¢é‡æ¸²æŸ“åŸç†

**Q: ä½ æåˆ°çš„â€œå¢é‡æ¸²æŸ“â€åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿä½ æ˜¯è‡ªå·±å†™ Diff ç®—æ³•å—ï¼Ÿ**

**A:**
ä¸ï¼Œæˆ‘æ²¡æœ‰é‡æ–°å‘æ˜è½®å­ï¼Œè€Œæ˜¯èµ‹èƒ½äº† Vue çš„ Diff ç®—æ³•ã€‚

1.  **ä¼ ç»Ÿåšæ³•**ï¼šMarkdown String -> HTML String -> `innerHTML` (æµè§ˆå™¨å½»åº•é‡ç»˜)ã€‚
2.  **æˆ‘çš„åšæ³•**ï¼šMarkdown String -> AST Object -> **Vue VNodes** -> Vue Patch -> DOMã€‚

è™½ç„¶åœ¨è§£æå±‚ï¼ˆParsing Layerï¼‰ç”±äº Markdown çš„ä¸Šä¸‹æ–‡ç›¸å…³æ€§ï¼ˆContext Sensitivityï¼‰æˆ‘ä»¬ä¾ç„¶éœ€è¦å…¨é‡è§£æï¼Œä½†åœ¨æ¸²æŸ“å±‚ï¼ˆRendering Layerï¼‰ï¼Œå› ä¸ºç”Ÿæˆçš„ AST ç»“æ„æ˜¯ç¨³å®šçš„ï¼ŒVue çš„ Diff ç®—æ³•èƒ½ç²¾ç¡®è¯†åˆ«å‡ºâ€œåªæœ‰æœ€åä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹å˜äº†â€ã€‚
**ç»“æœ**ï¼š99% çš„ DOM èŠ‚ç‚¹è¢«åŸåœ°å¤ç”¨ï¼ˆIn-place Reuseï¼‰ã€‚è¿™æŠŠåŸæœ¬ O(N) çš„ DOM æ“ä½œé™ç»´åˆ°äº† O(1) çš„æ–‡æœ¬èŠ‚ç‚¹æ›´æ–°ã€‚

### 2. æ¶æ„è®¾è®¡ï¼šä¸ºä»€ä¹ˆä¸ç”¨ v-htmlï¼Ÿ

**Q: ç›´æ¥ç”¨ `v-html` æ¸²æŸ“å‡ºæ¥ä¸ä¹Ÿä¸€æ ·å—ï¼Ÿä¸ºä»€ä¹ˆè¦ç»•è¿™ä¹ˆå¤§å¼¯è·¯è½¬ ASTï¼Ÿ**

**A:**
é™¤äº†åˆšæ‰è¯´çš„æ€§èƒ½ Diff é—®é¢˜ï¼Œæ ¸å¿ƒè¿˜åœ¨äº **"ç»„ä»¶åŒ–æ‹¦æˆª (Component Interception)"**ã€‚
AI è¾“å‡ºçš„å†…å®¹ä¸ä»…ä»…æ˜¯æ–‡æœ¬ï¼Œè¿˜æœ‰ Mermaid å›¾è¡¨ã€æ•°å­¦å…¬å¼ã€äº¤äº’å¼ä»£ç å—ã€‚

- `v-html` è¾“å‡ºçš„æ˜¯æ­» HTMLã€‚
- æœ‰äº† ASTï¼Œæˆ‘å¯ä»¥åœ¨ `RecursiveRenderer` ä¸­å®ç°**ä¸­é—´ä»¶æ¨¡å¼**ã€‚æ¯”å¦‚æ£€æµ‹åˆ° `class="language-mermaid"` çš„ `<code>` æ ‡ç­¾ï¼Œæˆ‘ç›´æ¥æ‹¦æˆªå®ƒï¼ŒæŠŠå®ƒæ›¿æ¢æˆä¸€ä¸ªæ´»çš„ Vue ç»„ä»¶ `<MermaidDiagram />`ã€‚è¿™è®© Markdown æ‹¥æœ‰äº†åº”ç”¨çº§çš„äº¤äº’èƒ½åŠ›ã€‚

### 3. å·¥ç¨‹åŒ–ä¸å¦¥åï¼šWorker çš„å–èˆ

**Q: æˆ‘çœ‹åˆ°ä½ å¼•å…¥äº† Web Workerï¼Œè¿™å¯¹æ€§èƒ½æå‡å¤§å—ï¼Ÿ**

**A:**
ï¼ˆè¿™é‡Œè¦å±•ç¤ºä½ çš„ç†æ€§æ€è€ƒï¼Œä¸è¦æ— è„‘å¹æ§ï¼‰
å®è¯å®è¯´ï¼Œ**æ”¶ç›Šæ˜¯æœ‰é™çš„ï¼Œå–å†³äºåœºæ™¯**ã€‚

- Worker åªèƒ½æŠŠ `String -> AST` è¿™ä¸ª CPU å¯†é›†å‹ä»»åŠ¡æŒªå‡ºä¸»çº¿ç¨‹ã€‚
- ä½†ä¸»çº¿ç¨‹ä¾ç„¶è¦æ‰¿æ‹…æœ€é‡çš„ `AST -> VNode -> DOM` çš„æ¸²æŸ“å‹åŠ›ã€‚
- åœ¨çŸ­æ–‡æœ¬åœºæ™¯ä¸‹ï¼ŒWorker çš„åºåˆ—åŒ–é€šä¿¡æˆæœ¬ï¼ˆSerialization Overheadï¼‰ç”šè‡³å¯èƒ½å¸¦æ¥è´Ÿæ”¶ç›Šã€‚
- **å®ƒçš„çœŸå®ä»·å€¼æ˜¯å…œåº•**ï¼šå½“ç”¨æˆ·ç²˜è´´äº† 5 ä¸‡å­—çš„é•¿æ–‡æ—¶ï¼ŒWorker èƒ½ä¿è¯ UI çº¿ç¨‹ä¸å®Œå…¨å¡æ­»ï¼ˆFreezeï¼‰ï¼Œä¿æŒæ»šåŠ¨æ¡è¿˜èƒ½åŠ¨ï¼Œä½†å¸§ç‡ä¾ç„¶ä¼šå—æ¸²æŸ“å±‚å½±å“ã€‚

### 4. ç»†èŠ‚äº®ç‚¹ï¼šæµå¼å…‰æ ‡ (Streaming Cursor)

**Q: æµå¼è¾“å‡ºæ—¶ï¼Œæ€ä¹ˆä¿è¯å…‰æ ‡ä¸€ç›´è·Ÿåœ¨æœ€åï¼Œè€Œä¸”ä¸æŠ–åŠ¨ï¼Ÿ**

**A:**
è¿™æ˜¯ä¸€ä¸ª UX ç»†èŠ‚ã€‚å¦‚æœç›´æ¥æŠŠå…‰æ ‡æ˜¯ä¸ª CSS ç±»åŠ åœ¨æœ«å°¾ï¼Œæ¯æ¬¡ AST æ›´æ–°å¯èƒ½ä¼šå¯¼è‡´å…‰æ ‡èŠ‚ç‚¹è¢«é”€æ¯é‡å»ºã€‚
æˆ‘å®ç°äº†ä¸€ä¸ª `manageCursor` ç®—æ³•ï¼š

1.  åœ¨ AST æ›´æ–°å‰ï¼Œé€»è¾‘ä¸Šæš‚å­˜å…‰æ ‡çŠ¶æ€ã€‚
2.  æ–° AST ç”Ÿæˆåï¼Œé€šè¿‡æ·±åº¦ä¼˜å…ˆæœç´¢ï¼ˆDFSï¼‰æ‰¾åˆ°**æœ€åä¸€ä¸ªæ˜¾è‘—æ–‡æœ¬èŠ‚ç‚¹ (Significant Text Node)**ã€‚
3.  å°†å…‰æ ‡ç»„ä»¶ç²¾å‡†æŒ‚è½½åˆ°è¯¥èŠ‚ç‚¹çš„å…„å¼Ÿä½ç½®ã€‚
    é…åˆ Vue çš„ Diffï¼Œåœ¨è§†è§‰ä¸Šå…‰æ ‡å°±åƒåœ¨æ–‡æœ¬æµä¸­â€œæ»‘è¡Œâ€ä¸€æ ·ï¼Œè€Œä¸æ˜¯ä¸æ–­åœ°â€œé—ªç°â€ã€‚

---

## ğŸ›  ç®€å†å…³é”®è¯ (Key Resume Phrases)

- **é«˜æ€§èƒ½æ¸²æŸ“**: Designed a **Stream-to-VNode** rendering pipeline specifically for LLM streaming responses, reducing DOM reflows by **90%+** compared to `v-html`.
- **æ¶æ„èƒ½åŠ›**: Decoupled parsing logic from rendering using an **AST-based middleware architecture**, enabling seamless integration of interactive Vue components (Mermaid, KaTeX) into static Markdown.
- **æ€§èƒ½ä¼˜åŒ–**: Implemented a **Fast-Path strategy** for incremental text updates and integrated **Web Workers** for off-main-thread parsing of large documents.
- **ç”¨æˆ·ä½“éªŒ**: Engineered a jitter-free cursor tracking system and "smart scroll" behavior compatible with variable-height content loading.
